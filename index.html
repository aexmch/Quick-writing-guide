import React, { useState, useEffect } from 'react';
import { 
  ChevronRight, BookOpen, Send, Layout, FileText, CheckCircle, RefreshCw, 
  Copy, ChevronLeft, Info, Sparkles, Trophy, BarChart3, Heart, 
  MessageSquare, School, Map, Globe, Lightbulb, Check, Zap, 
  Loader2, AlertCircle, Camera, Coffee, HelpCircle, History, 
  Search, ListChecks, PenTool
} from 'lucide-react';

const WRITING_TEMPLATES = {
  chart: {
    title: "åœ–è¡¨åˆ†æ",
    subtitle: "Chart Analysis",
    theme: "emerald",
    color: "text-emerald-600",
    bg: "bg-emerald-50",
    border: "border-emerald-200",
    btn: "bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200",
    accent: "bg-emerald-600",
    icon: <BarChart3 size={28} />,
    hasExample: true,
    exampleData: {
      type: "chart",
      title: "How High School Students Spend Their Time After School",
      items: [
        { label: "Cram School / Studying", value: 45, color: "bg-emerald-500" },
        { label: "Social Media / Gaming", value: 30, color: "bg-blue-500" },
        { label: "Sports / Clubs", value: 15, color: "bg-amber-500" },
        { label: "Sleeping / Others", value: 10, color: "bg-slate-400" }
      ]
    },
    steps: [
      { id: "hook", label: "Hook (é–‹é ­å¼•è¨€)", patterns: ["In recent years...", "Nowadays..."], words: ["crucial", "essential"], tip: "å¸å¼•è®€è€…æ³¨æ„è©²æ•¸æ“šä¸»é¡Œã€‚" },
      { id: "intro", label: "Introduce Chart (ç°¡ä»‹åœ–è¡¨)", patterns: ["The chart illustrates...", "The graph shows..."], words: ["illustrates", "depicts"], tip: "ä½¿ç”¨å¼•å°å¥å‹ç°¡ä»‹åœ–è¡¨å…§å®¹ã€‚" },
      { id: "trend", label: "Overall Trend (æ•´é«”è¶¨å‹¢)", patterns: ["Overall, it is clear that...", "What stands out is..."], words: ["dominant", "noteworthy"], tip: "æ‰¾å‡ºæ¯”ä¾‹æœ€å¤§èˆ‡æœ€å°çš„é …ç›®ã€‚" },
      { id: "details", label: "Key Details (é‡é»æ•¸æ“š)", patterns: ["...accounts for X%", "compared with"], words: ["approximately", "followed by"], tip: "æ¯”è¼ƒä¸åŒæ•¸æ“šä¹‹é–“çš„å·®è·ã€‚" },
      { id: "implication", label: "Comment/Implication (å•Ÿç¤º)", patterns: ["This suggests that...", "The data indicates that..."], words: ["implies", "consequently"], tip: "ç¸½çµæ•¸æ“šåæ˜ å‡ºçš„æ„ç¾©ã€‚" }
    ]
  },
  letter: {
    title: "ç§äººæ›¸ä¿¡",
    subtitle: "Personal Letter",
    theme: "rose",
    color: "text-rose-600",
    bg: "bg-rose-50",
    border: "border-rose-200",
    btn: "bg-rose-600 hover:bg-rose-700 shadow-rose-200",
    accent: "bg-rose-600",
    icon: <Heart size={28} />,
    hasExample: true,
    exampleData: {
      type: "text",
      title: "Mission: Repairing a Friendship",
      context: "ä½ èˆ‡å¥½å‹ Jamie å› ç‚ºèª¤æœƒåµæ¶ã€‚è«‹å¯«ä¿¡é“æ­‰ä¸¦å›æ†¶éå»çš„ç¾å¥½æ™‚å…‰ã€‚"
    },
    steps: [
      { id: "greeting", label: "Greeting (è¦ªæš±å•å€™)", patterns: ["Dearest [Name],", "Hey [Name],"], words: ["Dearest", "My friend"], tip: "ä½¿ç”¨æº«æš–çš„ç¨±å‘¼ã€‚" },
      { id: "purpose", label: "Opening (é–‹é ­èˆ‡ä¾†æ„)", patterns: ["I've been thinking a lot about...", "I'm writing to clear the air."], words: ["reflecting", "heavy heart"], tip: "å¦èª åœ°é–‹å•Ÿé“æ­‰è©±é¡Œã€‚" },
      { id: "details", label: "Feelings & Apology (æ„Ÿå—èˆ‡é“æ­‰)", patterns: ["I sincerely apologize for...", "I cherish our friendship."], words: ["sincerely", "regret"], tip: "çœŸèª é“æ­‰ä¸¦è§£é‡‹åŸå› ã€‚" },
      { id: "expectation", label: "Expectation (æœªä¾†çš„æœŸè¨±)", patterns: ["I hope we can...", "Let's grab a coffee."], words: ["reconnect", "forgive"], tip: "æå‡ºå…·é«”çš„ä¿®è£œå»ºè­°ã€‚" },
      { id: "closing", label: "Closing (æš–å¿ƒçµå°¾)", patterns: ["Best,", "Love,"], words: ["Truly yours", "Best wishes"], tip: "ä½¿ç”¨æº«æš–çš„çµå°¾èªã€‚" }
    ]
  },
  opinion: {
    title: "æ„è¦‹è¡¨é”",
    subtitle: "Opinion Writing",
    theme: "indigo",
    color: "text-indigo-600",
    bg: "bg-indigo-50",
    border: "border-indigo-200",
    btn: "bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200",
    accent: "bg-indigo-600",
    icon: <MessageSquare size={28} />,
    hasTopics: true,
    topics: [
      { id: "ai", title: "AI in Classroom", desc: "æ‡‰å¦å…è¨±åœ¨å­¸ç¿’ä¸­ä½¿ç”¨ AI å·¥å…·ï¼Ÿ", pro: "æå‡æ•ˆç‡", con: "å‰Šå¼±æ€è€ƒ" },
      { id: "ban", title: "Smartphone Ban", desc: "å­¸æ ¡æ‡‰å¦å…¨é¢ç¦æ­¢æ‰‹æ©Ÿï¼Ÿ", pro: "å°ˆæ³¨å­¸ç¿’", con: "è¯çµ¡å›°é›£" },
      { id: "conv", title: "Conv-Store Culture", desc: "è¶…å•†ä¾¿åˆ©æ€§æ˜¯åˆ©å¤§æ–¼å¼Šå—ï¼Ÿ", pro: "æ¥µè‡´ä¾¿åˆ©", con: "éåº¦æ¶ˆè²»" }
    ],
    steps: [
      { id: "hook", label: "Hook (ä¸»é¡Œå¼•å°)", patterns: ["...has sparkled heated debates.", "...is a hot topic lately."], words: ["controversial", "phenomenon"], tip: "æè¿°è­°é¡Œçš„é‡è¦æ€§ã€‚" },
      { id: "thesis", label: "Topic Sentence (ç«‹å ´è²æ˜)", patterns: ["From my perspective,", "I firmly believe that..."], words: ["standpoint", "convinced"], tip: "æ¸…æ¥šè¡¨é”ä½ çš„æ ¸å¿ƒç«‹å ´ã€‚" },
      { id: "reason1", label: "First Reason (ç†ç”±ä¸€)", patterns: ["Firstly,", "To begin with,"], words: ["primary", "essential"], tip: "çµ¦å‡ºé¦–è¦æ”¯æŒç†ç”±ã€‚" },
      { id: "reason2", label: "Second Reason (ç†ç”±äºŒ)", patterns: ["Furthermore,", "In addition,"], words: ["moreover", "equally important"], tip: "è£œå……å¦ä¸€å€‹æ”¯æŒé»ã€‚" },
      { id: "concession", label: "Concession (è®“æ­¥åé§)", patterns: ["Admittedly, ...", "While some argue that..."], words: ["nevertheless", "outweigh"], tip: "å…ˆæ‰¿èªå°æ–¹è§€é»å†åé§ã€‚" },
      { id: "conclusion", label: "Conclusion (ç¸½çµ)", patterns: ["In conclusion,", "To sum up,"], words: ["ultimately", "final thought"], tip: "é‡ç”³ç«‹å ´ä¸¦çµ¦äºˆå»ºè­°ã€‚" }
    ]
  },
  narrative: {
    title: "æ•˜äº‹å¯«ä½œ",
    subtitle: "Narrative Writing",
    theme: "amber",
    color: "text-amber-600",
    bg: "bg-amber-50",
    border: "border-amber-200",
    btn: "bg-amber-600 hover:bg-amber-700 shadow-amber-200",
    accent: "bg-amber-600",
    icon: <Camera size={28} />,
    hasExample: true,
    exampleData: {
      type: "text",
      title: "Mission: An Unexpected Lesson",
      context: "æè¿°ä¸€æ¬¡ä½ åŸæœ¬å¾ˆæœŸå¾…åƒåŠ æ´»å‹•ï¼Œæœ€å¾Œå»ç™¼ç”Ÿæ„å¤–ç‹€æ³ï¼Œè®“ä½ å­¸åˆ°é‡è¦ä¸€èª²çš„ç¶“æ­·ã€‚"
    },
    steps: [
      { id: "setting", label: "Setting (èƒŒæ™¯è¨­å®š)", patterns: ["It was a sunny morning when...", "I had been looking forward to..."], words: ["excited", "anticipation"], tip: "äº¤ä»£æ™‚é–“ã€åœ°é»èˆ‡ç•¶æ™‚çš„å¿ƒæƒ…ã€‚" },
      { id: "conflict", label: "Conflict (äº‹ä»¶ç™¼ç”Ÿ)", patterns: ["Unexpectedly, ...", "However, things took a turn when..."], words: ["suddenly", "shocked"], tip: "æè¿°æ„å¤–ç™¼ç”Ÿçš„é‚£ä¸€åˆ»ã€‚" },
      { id: "climax", label: "Climax (é«˜æ½®æƒ…ç¯€)", patterns: ["I found myself in a tough spot.", "At that moment, I realized..."], words: ["desperate", "struggle"], tip: "æè¿°æœ€ç·Šå¼µæˆ–æœ€é‡è¦çš„è½‰æŠ˜ã€‚" },
      { id: "resolution", label: "Resolution (å•é¡Œè§£æ±º)", patterns: ["Eventually, I decided to...", "With the help of..."], words: ["relief", "resolved"], tip: "æ•…äº‹æ˜¯å¦‚ä½•è½å¹•çš„ï¼Ÿ" },
      { id: "theme", label: "Lesson (å•Ÿç¤ºç¸½çµ)", patterns: ["Looking back, I learned that...", "This experience taught me..."], words: ["valuable", "transformed"], tip: "é€™æ¬¡ç¶“æ­·å¸¶çµ¦ä½ çš„æˆé•·ã€‚" }
    ]
  },
  person: {
    title: "äººç‰©æè¿°",
    subtitle: "Descriptive: Person",
    theme: "cyan",
    color: "text-cyan-600",
    bg: "bg-cyan-50",
    border: "border-cyan-200",
    btn: "bg-cyan-600 hover:bg-cyan-700 shadow-cyan-200",
    accent: "bg-cyan-600",
    icon: <Search size={28} />,
    steps: [
      { id: "intro", label: "Introduction (äººç‰©ç°¡ä»‹)", patterns: ["I'd like to talk about...", "The person I admire most is..."], words: ["influence", "extraordinary"], tip: "ä»‹ç´¹é€™å€‹äººçš„èº«ä»½èˆ‡ä½ å€‘çš„é—œä¿‚ã€‚" },
      { id: "appearance", label: "Appearance (å¤–å‹ç‰¹å¾µ)", patterns: ["He/She has a ... look.", "What strikes me first is..."], words: ["energetic", "distinguished"], tip: "æè¿°è¦–è¦ºä¸Šçš„ç¬¬ä¸€å°è±¡ã€‚" },
      { id: "personality", label: "Personality (å…§åœ¨å€‹æ€§)", patterns: ["He/She is known for...", "Beyond appearance, he/she is..."], words: ["compassionate", "humorous"], tip: "åˆ—èˆ‰ 2-3 å€‹æ€§æ ¼å„ªé»ã€‚" },
      { id: "example", label: "Specific Example (å…·é«”äº‹ä¾‹)", patterns: ["I remember a time when...", "This shows how kind he/she is."], words: ["dedication", "inspired"], tip: "ç”¨ä¸€ä»¶äº‹è­‰æ˜é€™å€‹äººçš„ç‰¹è³ªã€‚" },
      { id: "impact", label: "Impact (å°ä½ çš„å½±éŸ¿)", patterns: ["He/She has taught me...", "Because of him/her, I..."], words: ["role model", "gratitude"], tip: "ç¸½çµä»–å°ä½ çš„é‡è¦æ€§ã€‚" }
    ]
  },
  place: {
    title: "åœ°é»æè¿°",
    subtitle: "Descriptive: Place",
    theme: "lime",
    color: "text-lime-600",
    bg: "bg-lime-50",
    border: "border-lime-200",
    btn: "bg-lime-600 hover:bg-lime-700 shadow-lime-200",
    accent: "bg-lime-600",
    icon: <Map size={28} />,
    steps: [
      { id: "intro", label: "Location (åœ°é»èƒŒæ™¯)", patterns: ["Located in the heart of...", "There is a hidden gem called..."], words: ["destination", "situated"], tip: "èªªæ˜åœ°é»åœ¨å“ªè£¡ï¼Œç‚ºä½•ç‰¹åˆ¥ã€‚" },
      { id: "senses", label: "Sensory Details (æ„Ÿå®˜æè¿°)", patterns: ["I can hear the sound of...", "The air is filled with the scent of..."], words: ["breathtaking", "vibrant"], tip: "é‹ç”¨è¦–ã€è½ã€å—…ã€å‘³ã€è§¸è¦ºæè¿°ã€‚" },
      { id: "activity", label: "Activity (ç•¶åœ°æ´»å‹•)", patterns: ["Visitors can enjoy...", "One thing you must do here is..."], words: ["exploration", "unwind"], tip: "äººå€‘åœ¨é‚£è£¡é€šå¸¸åšä»€éº¼ï¼Ÿ" },
      { id: "atmosphere", label: "Atmosphere (æ°›åœæ°›åœ)", patterns: ["The place has a ... vibe.", "It feels like..."], words: ["peaceful", "bustling"], tip: "æè¿°é€™å€‹åœ°é»çµ¦äººçš„å¿ƒç†æ„Ÿå—ã€‚" },
      { id: "conclusion", label: "Conclusion (ç¸½çµå¿ƒå¾—)", patterns: ["It is more than just a place...", "I highly recommend visiting..."], words: ["unforgettable", "worthwhile"], tip: "ç¸½çµå®ƒç‚ºä½•å€¼å¾—ä¸€å»ã€‚" }
    ]
  },
  problem: {
    title: "è§£æ±ºå•é¡Œ",
    subtitle: "Problem & Solution",
    theme: "orange",
    color: "text-orange-600",
    bg: "bg-orange-50",
    border: "border-orange-200",
    btn: "bg-orange-600 hover:bg-orange-700 shadow-orange-200",
    accent: "bg-orange-600",
    icon: <HelpCircle size={28} />,
    steps: [
      { id: "problem", label: "The Problem (ç¾ç‹€å•é¡Œ)", patterns: ["One major issue we face is...", "Recently, ... has become a serious problem."], words: ["concerning", "challenge"], tip: "æè¿°ç›®å‰é‡åˆ°çš„å…·é«”å•é¡Œã€‚" },
      { id: "causes", label: "The Causes (èƒŒå¾Œèµ·å› )", patterns: ["The main reason behind this is...", "This problem arises from..."], words: ["root cause", "contributing factors"], tip: "åˆ†æå•é¡Œç™¼ç”Ÿçš„åŸå› ã€‚" },
      { id: "solution1", label: "Solution 1 (å°ç­–ä¸€)", patterns: ["To address this, we could...", "The first step is to..."], words: ["implementation", "effective"], tip: "æå‡ºç¬¬ä¸€å€‹å¯è¡Œçš„è§£æ±ºæ–¹æ¡ˆã€‚" },
      { id: "solution2", label: "Solution 2 (å°ç­–äºŒ)", patterns: ["In addition, ...", "Another potential solution is..."], words: ["furthermore", "alternative"], tip: "æå‡ºå¦ä¸€å€‹äº’è£œçš„å»ºè­°ã€‚" },
      { id: "outlook", label: "Outlook (æœªä¾†å±•æœ›)", patterns: ["By doing so, we can...", "I believe that with these efforts..."], words: ["sustainable", "promising"], tip: "æè¿°è§£æ±ºå¾Œçš„ç†æƒ³çµæœã€‚" }
    ]
  },
  compare: {
    title: "å°æ¯”æ¯”è¼ƒ",
    subtitle: "Compare & Contrast",
    theme: "purple",
    color: "text-purple-600",
    bg: "bg-purple-50",
    border: "border-purple-200",
    btn: "bg-purple-600 hover:bg-purple-700 shadow-purple-200",
    accent: "bg-purple-600",
    icon: <ListChecks size={28} />,
    steps: [
      { id: "intro", label: "Subjects (å°è±¡ç°¡ä»‹)", patterns: ["While A and B share similarities, they differ in...", "Comparing A and B reveals..."], words: ["comparison", "distinct"], tip: "ä»‹ç´¹ä½ è¦æ¯”è¼ƒçš„å…©å€‹å°è±¡ã€‚" },
      { id: "similarity", label: "Similarities (å…±åŒé»)", patterns: ["Both A and B are...", "Similarly, both of them..."], words: ["likewise", "in common"], tip: "æè¿°å…©è€…ä¹‹é–“ç›¸ä¼¼çš„åœ°æ–¹ã€‚" },
      { id: "difference", label: "Differences (ç›¸ç•°é»)", patterns: ["On the contrary, ...", "Unlike A, B tends to..."], words: ["whereas", "striking contrast"], tip: "èšç„¦æè¿°å…©è€…çš„ä¸»è¦å€åˆ¥ã€‚" },
      { id: "preference", label: "Preference (å€‹äººåå¥½)", patterns: ["As for me, I prefer A because...", "If I had to choose, I would..."], words: ["choice", "preference"], tip: "èªªæ˜ä½ æ¯”è¼ƒå–œæ­¡å“ªä¸€å€‹ï¼Œç†ç”±ç‚ºä½•ã€‚" },
      { id: "summary", label: "Final Thought (çµèªç¸½çµ)", patterns: ["In short, both have their pros and cons.", "Choosing between them depends on..."], words: ["perspective", "ultimate"], tip: "ç¸½çµæ¯”è¼ƒçš„å¿ƒå¾—ã€‚" }
    ]
  },
  process: {
    title: "æµç¨‹æ­¥é©Ÿ",
    subtitle: "Process Writing",
    theme: "yellow",
    color: "text-yellow-700",
    bg: "bg-yellow-50",
    border: "border-yellow-200",
    btn: "bg-yellow-600 hover:bg-yellow-700 shadow-yellow-200",
    accent: "bg-yellow-600",
    icon: <PenTool size={28} />,
    steps: [
      { id: "intro", label: "Objective (ç›®æ¨™æº–å‚™)", patterns: ["To make a perfect ..., you need...", "The process of ... is quite simple."], words: ["essential", "preparation"], tip: "èªªæ˜ç›®æ¨™æ˜¯ä»€éº¼ï¼Œéœ€è¦ä»€éº¼æº–å‚™ã€‚" },
      { id: "step1", label: "Step 1 (ç¬¬ä¸€æ­¥)", patterns: ["First, you should...", "To begin with, ..."], words: ["initially", "commence"], tip: "æè¿°æµç¨‹çš„ç¬¬ä¸€å€‹æ­¥é©Ÿã€‚" },
      { id: "step2", label: "Next Steps (å¾ŒçºŒæµç¨‹)", patterns: ["After that, ...", "The next step is to..."], words: ["subsequently", "followed by"], tip: "æè¿°ä¸­é–“é—œéµçš„è½‰æŠ˜èˆ‡æ“ä½œã€‚" },
      { id: "caution", label: "Cautions (æ³¨æ„äº‹é …)", patterns: ["Be careful not to...", "It is important to remember that..."], words: ["precautions", "watchful"], tip: "æé†’å®¹æ˜“å‡ºéŒ¯æˆ–éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚" },
      { id: "result", label: "Result (æˆæœå±•ç¤º)", patterns: ["Finally, you will have a...", "Now you can enjoy your..."], words: ["accomplishment", "satisfying"], tip: "æè¿°æœ€å¾Œå®Œæˆçš„ç‹€æ…‹ã€‚" }
    ]
  },
  summary: {
    title: "å¿ƒå¾—æ‘˜è¦",
    subtitle: "Summary Writing",
    theme: "slate",
    color: "text-slate-600",
    bg: "bg-slate-50",
    border: "border-slate-200",
    btn: "bg-slate-600 hover:bg-slate-700 shadow-slate-200",
    accent: "bg-slate-600",
    icon: <History size={28} />,
    steps: [
      { id: "overview", label: "Overview (å…§å®¹æ¦‚è§€)", patterns: ["The story/article tells us about...", "I recently read a book titled..."], words: ["summary", "content"], tip: "ç”¨ä¸€å¥è©±äº¤ä»£æ–‡ç« æˆ–æ›¸åçš„æ ¸å¿ƒã€‚" },
      { id: "main_points", label: "Main Points (é‡é»æ‘˜éŒ„)", patterns: ["The author emphasizes that...", "The core message is..."], words: ["highlight", "central theme"], tip: "æå–ä½œè€…æœ€æƒ³å‚³é”çš„ 2-3 å€‹è§€å¿µã€‚" },
      { id: "favorite", label: "Favorite Part (æœ€æ„›éƒ¨åˆ†)", patterns: ["What impressed me most was...", "The most touching part is when..."], words: ["impact", "impressive"], tip: "æè¿°æœ€è®“ä½ é›£å¿˜çš„æƒ…ç¯€æˆ–å¥å­ã€‚" },
      { id: "reflection", label: "Reflection (å€‹äººçœæ€)", patterns: ["I started to realize that...", "This made me think about..."], words: ["realization", "insight"], tip: "é€™æ®µå…§å®¹å°ä½ å€‹äººçš„å•Ÿç™¼ã€‚" },
      { id: "recommend", label: "Recommendation (æ¨è–¦èª)", patterns: ["I would recommend this to...", "It is definitely a must-read."], words: ["highly suggested", "worthwhile"], tip: "ä½ æœƒæ¨è–¦çµ¦èª°ï¼Ÿç‚ºä»€éº¼ï¼Ÿ" }
    ]
  },
  diary: {
    title: "ç”Ÿæ´»æ—¥è¨˜",
    subtitle: "Diary Entry",
    theme: "violet",
    color: "text-violet-600",
    bg: "bg-violet-50",
    border: "border-violet-200",
    btn: "bg-violet-600 hover:bg-violet-700 shadow-violet-200",
    accent: "bg-violet-600",
    icon: <Coffee size={28} />,
    steps: [
      { id: "date", label: "Date & Mood (æ—¥æœŸå¿ƒæƒ…)", patterns: ["March 15, Sunny.", "Today was a ... day."], words: ["exhausted", "delighted"], tip: "å¯«ä¸‹ä»Šå¤©çš„æ—¥æœŸèˆ‡æ•´é«”çš„å¿ƒæƒ…è‰²èª¿ã€‚" },
      { id: "event", label: "Major Event (ä»Šæ—¥å¤§äº‹)", patterns: ["Something interesting happened today.", "I spent most of my time..."], words: ["unforgettable", "ordinary"], tip: "æè¿°ä»Šå¤©ç™¼ç”Ÿæœ€å€¼å¾—è¨˜ä¸‹ä¾†çš„ä¸€ä»¶äº‹ã€‚" },
      { id: "feeling", label: "Emotions (å…§å¿ƒæƒ…æ„Ÿ)", patterns: ["I felt a bit ... when...", "I'm still thinking about..."], words: ["overwhelmed", "grateful"], tip: "æ·±å…¥æå¯«é€™ä»¶äº‹å¸¶çµ¦ä½ çš„å¿ƒç†æ„Ÿå—ã€‚" },
      { id: "gratitude", label: "Small Gratitude (å°ç¢ºå¹¸)", patterns: ["I'm grateful for...", "One good thing today was..."], words: ["blessing", "appreciation"], tip: "å¯«ä¸‹ä¸€ä»¶è®“ä½ æ„Ÿåˆ°æ„Ÿæ¿€çš„å°äº‹ã€‚" },
      { id: "tomorrow", label: "Hope (æ˜æ—¥æœŸè¨±)", patterns: ["Tomorrow, I hope I can...", "Looking forward to another..."], words: ["anticipate", "fresh start"], tip: "å°æ˜å¤©çš„è‡ªå·±èªªä¸€å¥è©±ã€‚" }
    ]
  }
};

const App = () => {
  const [selectedMode, setSelectedMode] = useState(null);
  const [selectedTopic, setSelectedTopic] = useState(null);
  const [currentStep, setCurrentStep] = useState(0);
  const [answers, setAnswers] = useState({});
  const [isFinished, setIsFinished] = useState(false);
  const [copied, setCopied] = useState(false);
  
  // AI Feedback State
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiFeedback, setAiFeedback] = useState(null);
  const [aiError, setAiError] = useState(null);

  const currentTheme = selectedMode ? WRITING_TEMPLATES[selectedMode] : null;

  const handleInputChange = (id, value) => {
    setAnswers(prev => ({ ...prev, [id]: value }));
    if (aiFeedback) setAiFeedback(null);
  };

  const getAIFeedback = async () => {
    const userInput = answers[currentTheme.steps[currentStep].id];
    if (!userInput || userInput.trim().length < 5) return;

    setIsAiLoading(true);
    setAiError(null);
    setAiFeedback(null);

    const apiKey = ""; 
    const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è‹±æ–‡å¯«ä½œè€å¸«ã€‚
    å­¸ç”Ÿæ­£åœ¨ç·´ç¿’ã€Œ${currentTheme.title}ã€çš„ã€Œ${currentTheme.steps[currentStep].label}ã€æ­¥é©Ÿã€‚
    æƒ…å¢ƒï¼š${selectedTopic ? selectedTopic.title : (currentTheme.exampleData?.title || "è‡ªç”±å¯«ä½œ")}ã€‚
    
    è«‹åˆ†æå­¸ç”Ÿçš„å¥å­ä¸¦æä¾›ä»¥ä¸‹ JSONï¼š
    {
      "isGrammarCorrect": boolean,
      "corrected": "ä¿®æ­£å¾Œçš„å¥å­ï¼ˆå¦‚æœ‰éŒ¯èª¤ï¼‰",
      "explanation": "ä¸­æ–‡è§£é‡‹æ”¹é€²ç©ºé–“",
      "betterVersion": "ç¬¦åˆå¯«ä½œæ‰‹å†Šæ¶æ§‹çš„é«˜ç´šé“åœ°å¯«æ³•",
      "vocabularyTips": ["æ¨è–¦çš„é«˜ç´šè©å½™"]
    }`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `å­¸ç”Ÿå¥å­ï¼š "${userInput}"` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      if (!response.ok) throw new Error('API Error');
      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiFeedback(JSON.parse(text));
    } catch (err) {
      setAiError("AI å°å¸«æš«æ™‚é›¢ç·šï¼Œè«‹æª¢æŸ¥æ–‡æ³•å¾Œç¹¼çºŒã€‚");
    } finally {
      setIsAiLoading(false);
    }
  };

  const applyAiSuggestion = () => {
    if (aiFeedback?.betterVersion) {
      handleInputChange(currentTheme.steps[currentStep].id, aiFeedback.betterVersion);
      setAiFeedback(null);
    }
  };

  const startMode = (mode) => {
    setSelectedMode(mode);
    setSelectedTopic(null);
    setCurrentStep(0);
    setAnswers({});
    setIsFinished(false);
    setAiFeedback(null);
  };

  return (
    <div className={`min-h-screen transition-all duration-700 ${selectedMode ? currentTheme.bg : 'bg-slate-50'} text-slate-900 font-sans p-4 md:p-8`}>
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <header className="mb-8 text-center">
          <h1 className="text-4xl font-black text-slate-800 flex items-center justify-center gap-3 italic tracking-tight uppercase">
            <Sparkles className={selectedMode ? currentTheme.color : "text-blue-600"} />
            Writing Workshop
          </h1>
          <p className="text-slate-500 mt-2 font-medium uppercase tracking-widest text-xs">ä¾æ“š 11 ç¨®æ¶æ§‹ï¼Œæ‰“é€ é€£è²«æ®µè½</p>
        </header>

        {/* Home Screen - Grid of 11 Types */}
        {!selectedMode ? (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mt-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {Object.entries(WRITING_TEMPLATES).map(([key, template]) => (
              <button key={key} onClick={() => startMode(key)} className="group p-6 bg-white rounded-3xl shadow-md border-2 border-transparent hover:border-blue-400 transition-all text-left transform hover:-translate-y-1">
                <div className={`w-12 h-12 ${template.bg} ${template.color} rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform`}>
                  {template.icon}
                </div>
                <h3 className="text-xl font-bold text-slate-800">{template.title}</h3>
                <p className="text-xs text-slate-400 font-medium tracking-tight mb-2 uppercase">{template.subtitle}</p>
                <p className="text-xs text-slate-500 leading-relaxed line-clamp-2">å¾ªåºæ¼¸é€²ç·´ç¿’äº”å¤§æ¶æ§‹ï¼ŒåŒ…å«å°ˆå±¬è©å½™å¼•å°ã€‚</p>
              </button>
            ))}
          </div>
        ) : isFinished ? (
          /* Result View */
          <div className="max-w-4xl mx-auto bg-white rounded-[2.5rem] shadow-2xl p-10 border border-white animate-in zoom-in duration-500">
            <div className="flex items-center justify-between mb-8">
              <h2 className="text-3xl font-black flex items-center gap-3 text-slate-800"><Trophy className="text-yellow-500" /> ç·´ç¿’å®Œæˆï¼</h2>
              <button onClick={() => startMode(null)} className="p-3 bg-slate-100 rounded-2xl hover:bg-slate-200"><RefreshCw size={20} /></button>
            </div>
            <div className={`p-8 rounded-[2rem] border-2 ${currentTheme.border} ${currentTheme.bg} mb-8 text-xl text-slate-700 font-serif italic leading-loose shadow-inner`}>
              {currentTheme.steps.map(step => answers[step.id] || "").filter(t => t).join(" ")}
            </div>
            <div className="flex gap-4">
               <button onClick={() => {
                 const text = currentTheme.steps.map(s => answers[s.id] || "").join(" ");
                 const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                 setCopied(true); setTimeout(() => setCopied(false), 2000);
               }} className={`flex-1 ${currentTheme.btn} text-white py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3 shadow-xl transition-all`}>
                 {copied ? <CheckCircle /> : <Copy />} {copied ? "å·²è¤‡è£½" : "è¤‡è£½å…¨æ–‡"}
               </button>
               <button onClick={() => setIsFinished(false)} className="px-10 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200">è¿”å›ä¿®æ”¹</button>
            </div>
          </div>
        ) : currentTheme.hasTopics && !selectedTopic ? (
          /* Topic Selection (e.g., Opinion) */
          <div className="max-w-4xl mx-auto animate-in slide-in-from-bottom-8">
            <h2 className="text-3xl font-black text-slate-800 text-center mb-10 tracking-tight">è«‹é¸æ“‡ç·´ç¿’è­°é¡Œï¼š</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {currentTheme.topics.map(topic => (
                <button key={topic.id} onClick={() => setSelectedTopic(topic)} className="bg-white p-8 rounded-[2rem] shadow-xl border-2 border-transparent hover:border-indigo-400 transition-all text-left group">
                  <h3 className="text-xl font-bold text-slate-800 mb-2 group-hover:text-indigo-600">{topic.title}</h3>
                  <p className="text-sm text-slate-500 mb-4">{topic.desc}</p>
                  <div className="flex flex-col gap-1 text-[10px] font-bold">
                    <span className="text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PRO: {topic.pro}</span>
                    <span className="text-rose-600 bg-rose-50 px-2 py-1 rounded">CON: {topic.con}</span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        ) : (
          /* Writing Scaffold UI */
          <div className="flex flex-col lg:flex-row gap-8 items-start animate-in slide-in-from-bottom-8">
            {/* Left: Context / Resources */}
            <div className="w-full lg:w-1/3 space-y-4 lg:sticky lg:top-8">
              <div className="bg-white rounded-[2rem] shadow-xl p-6 border border-white">
                <div className="flex items-center gap-2 mb-4">
                   {currentTheme.icon} <span className="font-black text-slate-800 text-sm uppercase tracking-widest">ä»»å‹™æƒ…å¢ƒèˆ‡åƒè€ƒ</span>
                </div>
                {currentModeContext(currentTheme, selectedTopic)}
              </div>
              {/* Pattern Bank */}
              <div className="bg-slate-800 rounded-[2rem] p-6 text-white shadow-xl">
                 <h3 className="text-xs font-black uppercase tracking-widest text-blue-400 mb-4 flex items-center gap-2"><Lightbulb size={16}/> æ¨è–¦å¥å‹</h3>
                 <div className="flex flex-wrap gap-2">
                    {currentTheme.steps[currentStep].patterns.map((p, i) => (
                      <span key={i} onClick={() => handleInputChange(currentTheme.steps[currentStep].id, (answers[currentTheme.steps[currentStep].id] || "") + p.replace('...', ' '))} className="text-[10px] bg-white/10 px-2 py-1 rounded-lg border border-white/5 cursor-pointer hover:bg-white/20">{p}</span>
                    ))}
                 </div>
                 <h3 className="text-xs font-black uppercase tracking-widest text-emerald-400 mt-6 mb-4 flex items-center gap-2"><PenTool size={16}/> é—œéµå–®å­—</h3>
                 <div className="flex flex-wrap gap-2">
                    {currentTheme.steps[currentStep].words.map((w, i) => (
                      <span key={i} className="text-[10px] text-emerald-200 font-bold tracking-tighter">#{w}</span>
                    ))}
                 </div>
              </div>
            </div>

            {/* Right: Writing Area */}
            <div className="flex-1 bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-white">
              <div className={`${currentTheme.accent} p-6 text-white flex justify-between items-center`}>
                <button onClick={() => selectedTopic ? setSelectedTopic(null) : setSelectedMode(null)} className="p-2 hover:bg-black/10 rounded-xl"><ChevronLeft size={24} /></button>
                <div className="text-center">
                  <span className="text-[10px] font-black opacity-70 block tracking-widest">{currentTheme.subtitle}</span>
                  <span className="font-bold text-lg">{currentTheme.steps[currentStep].label}</span>
                </div>
                <div className="bg-white/20 px-3 py-1 rounded-full text-xs font-black">{currentStep + 1} / {currentTheme.steps.length}</div>
              </div>

              <div className="p-8 md:p-10">
                <div className="mb-6">
                  <textarea autoFocus className="w-full h-44 p-6 bg-slate-50 border-2 border-slate-100 rounded-[2.5rem] focus:bg-white focus:border-blue-500 focus:outline-none transition-all text-xl font-serif leading-relaxed" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„ç·´ç¿’å¥å­..." value={answers[currentTheme.steps[currentStep].id] || ""} onChange={(e) => handleInputChange(currentTheme.steps[currentStep].id, e.target.value)} />
                  <div className="flex justify-between items-center mt-4">
                     <p className="text-xs text-slate-400 italic">ğŸ’¡ é»æ“Šå·¦å´æ¨è–¦å¥å‹å¯ç›´æ¥æ’å…¥ã€‚</p>
                     <button onClick={getAIFeedback} disabled={isAiLoading || !answers[currentTheme.steps[currentStep].id]?.trim()} className={`flex items-center gap-2 px-6 py-3 rounded-2xl font-black text-sm transition-all ${isAiLoading ? 'bg-slate-100 text-slate-400' : 'bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg active:scale-95'}`}>
                        {isAiLoading ? <Loader2 className="animate-spin" /> : <Zap size={16} />} AI ä¿®æ­£å»ºè­°
                     </button>
                  </div>

                  {aiFeedback && (
                    <div className="mt-6 animate-in slide-in-from-top-4 bg-indigo-50 border-2 border-indigo-100 rounded-[2rem] p-6">
                      <div className="flex items-center gap-2 mb-4 font-black text-indigo-600 text-xs uppercase"><Sparkles size={16}/> AI å°å¸«åˆ†æ</div>
                      {!aiFeedback.isGrammarCorrect && <div className="mb-4 p-4 bg-rose-50 rounded-xl text-rose-700 text-sm italic border border-rose-100">ä¿®æ­£ï¼š{aiFeedback.corrected}</div>}
                      <p className="text-sm text-slate-600 mb-4 font-medium">{aiFeedback.explanation}</p>
                      <div className="p-5 bg-white rounded-2xl border-2 border-indigo-200 relative group">
                        <button onClick={applyAiSuggestion} className="absolute top-2 right-2 text-xs font-bold bg-indigo-600 text-white px-3 py-1 rounded-lg">æ¡ç”¨å»ºè­° <Check size={12} className="inline"/></button>
                        <span className="text-[10px] font-black text-indigo-300 block mb-1">æ›´å¥½ã€æ›´é“åœ°çš„è¡¨é”ï¼š</span>
                        <p className="text-lg text-slate-800 font-serif font-bold italic">{aiFeedback.betterVersion}</p>
                      </div>
                    </div>
                  )}
                </div>
                <div className="flex justify-between items-center pt-2">
                  <button disabled={currentStep === 0} onClick={() => setCurrentStep(c => c - 1)} className="px-8 py-4 text-slate-400 font-bold disabled:opacity-30">å›ä¸Šä¸€æ­¥</button>
                  <button onClick={() => { if(currentStep < currentTheme.steps.length - 1) { setCurrentStep(c => c + 1); setAiFeedback(null); } else setIsFinished(true); }} className={`${currentTheme.btn} text-white px-12 py-4 rounded-2xl font-black text-lg shadow-xl flex items-center gap-2`}>
                    {currentStep === currentTheme.steps.length - 1 ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥"} <ChevronRight size={20} />
                  </button>
                </div>
              </div>
              <div className="bg-slate-900 p-8 text-white/90">
                <span className="text-[10px] font-black text-white/30 tracking-[0.3em] block mb-2 uppercase">Current Paragraph Draft</span>
                <p className="text-lg font-serif italic opacity-70 leading-relaxed max-h-24 overflow-y-auto">{Object.values(answers).filter(v => v).join(" ") || "æ®µè½é è¦½å°‡é¡¯ç¤ºæ–¼æ­¤..."}</p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// Helper to render context based on type
const currentModeContext = (theme, selectedTopic) => {
  if (theme.hasTopics && selectedTopic) {
    return <p className="text-sm text-slate-600 bg-indigo-50 p-4 rounded-xl leading-relaxed">{selectedTopic.desc}</p>;
  }
  if (theme.hasExample && theme.exampleData) {
    if (theme.exampleData.type === 'chart') {
      return (
        <div className="space-y-4">
          <h4 className="font-bold text-slate-700 text-xs">{theme.exampleData.title}</h4>
          <div className="space-y-3">
            {theme.exampleData.items.map((item, idx) => (
              <div key={idx} className="space-y-1 text-[10px]">
                <div className="flex justify-between font-bold"><span>{item.label}</span><span>{item.value}%</span></div>
                <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${item.color}`} style={{ width: `${item.value}%` }}></div></div>
              </div>
            ))}
          </div>
        </div>
      );
    }
    return <p className="text-sm italic text-slate-600 bg-slate-50 p-4 rounded-xl">"{theme.exampleData.context}"</p>;
  }
  return <p className="text-sm text-slate-400 italic bg-slate-50 p-4 rounded-xl">æ ¹æ“šæ­¤å–®å…ƒçš„é‚è¼¯æ¶æ§‹ï¼Œè‡ªç”±ç·´ç¿’æƒ³å¯«çš„ä¸»é¡Œå…§å®¹ã€‚</p>;
};

export default App;
